<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../google-apis/google-apis.html">
<link rel="import" href="../google-signin/google-signin.html">
<link rel="import" href="file-extension.html">

<dom-module id="file-browser">

    <style>

    </style>

    <template>
        <paper-tabs selected="{{_selected}}">
            <paper-tab>Local</paper-tab>
            <paper-tab>Google</paper-tab>

        </paper-tabs>
        <iron-pages selected="{{_selected}}">
            <div>Local</div>
            <div id="google_drive_list">
                Google

                <google-signin width="iconOnly"
                    client-id="{{google_client_id}}"
                    scopes="https://www.googleapis.com/auth/drive"
                    on-google-signin-aware-success="_set_authenticated_state"
                    on-google-signed-out="_set_authenticated_state"></google-signin>



                <template id="file_list_api" is="dom-if" if="{{_google_authenticated}}">
                    Authenticated
                    <google-client-loader id="gdrive_api"
                        name="drive" version="v2"
                        on-google-api-load="_first_google_file_lookup"
                        on-google-api-load-error="_google_api_load_error"></google-client-loader>
                </template>
            </div>
        </iron-pages>
        <div id="file-list">
            <template id="" is="dom-repeat" items="{{currentFiles}}">
                <span><img src="{{item.icon}}"/><span>{{item.fileName}}</span></span>
            </template>
        </div>
        <select id="fileExtension">
            <template is="dom-repeat" items="{{_file_extensions}}" as="fe">
                <option value="{{fe.extension}}">{{fe.display_name}}</option>
            </template>
        </select>
    </template>

    <script>


        FileBrowser = Polymer({
            is: 'file-browser',
            properties: {
                currentFiles: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _file_extensions: {
                    type: Array,
                    value: function () {

                        return Polymer.dom(this).querySelectorAll('file-extension');
                    }
                },
                _google_authenticated: {
                    type: Boolean,
                    value: false
                },
                _selected: {type: Number, value: 1},
                google_client_id: {
                    type: String,
                    notify: true
                }
            },

            ready: function () {
                var drive = Polymer.dom(this.root).querySelector('#gdrive_api');

            },

            _set_authenticated_state: function (event) {
                this._google_authenticated = ( event.type === "google-signin-aware-success");
            },

            _first_google_file_lookup: function (event) {
                console.log("File Lookup started");
                var addFile = this;
                var drive = event.target;
                this._load_google_files(drive);
                
            },

            _load_google_files: function(drive){
                var fileSearch = drive.api.files.list({
                    q: "fileExtension = '" + this.$.fileExtension.value + "'"
                });

                fileSearch.execute(function(resp){

                    resp.items.forEach(function(item){
                        addFile.push('currentFiles', {icon: item.iconLink, fileName: item.originalFilename});
                    });
                });
            },

            _google_api_load_error: function (event) {
                console.log("Error");
                if (event.detail.error.code == 401) {
                    checkAuth();
                } else {
                    console.log("Error");
                }
            }
        });

    </script>

</dom-module>
