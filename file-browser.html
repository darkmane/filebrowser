<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../google-apis/google-apis.html">
<link rel="import" href="../google-signin/google-signin.html">
<link rel="import" href="file-extension.html">

<dom-module id="file-browser">

    <style>
        paper-button[toggles][active] {
            background: #d1d1d1;
        }


    </style>

    <template>
        <paper-tabs selected="{{_selected}}">
            <paper-tab>Local</paper-tab>
            <paper-tab>                <google-signin width="wide"
                                                      client-id="{{google_client_id}}"
                                                      scopes="https://www.googleapis.com/auth/drive"
                                                      on-google-signin-aware-success="_set_authenticated_state"
                                                      on-google-signed-out="_set_authenticated_state"></google-signin>
                </paper-tab>
            <paper-tab>OneDrive</paper-tab>
            <paper-tab>Box.net</paper-tab>

        </paper-tabs>
        <iron-pages selected="{{_selected}}">
            <div id="local_list">Local<br>

                <input type="file" accept="{{_selected_extension}}">
            </div>
            <div id="google_drive_list">
                <template id="file_list_api" is="dom-if" if="{{_google_authenticated}}">

                    <google-client-loader id="gdrive_api"
                                          name="drive" version="v2"
                                          on-google-api-load="_google_file_lookup_eventhandler"
                                          on-google-api-load-error="_google_api_load_error"></google-client-loader>
                </template>
            </div>
            <div id="onedrive_list">One Drive</div>
            <div id="boxnet_list">Box.net</div>
        </iron-pages>
        <div id="file-list">
            <template id="fileList" is="dom-repeat" items="{{currentFiles}}">
                <paper-item>
                    <paper-button active="{{item.selected}}" toggles raised noink on-tap="_select_file">
                        <iron-icon icon="add-circle-outline"></iron-icon>

                        &nbsp;<span>{{item.fileName}}</span></paper-button>

                </paper-item>
            </template>
        </div>
        <select id="fileExtension" on-change="_file_extension_change">
            <template is="dom-repeat" items="{{_file_extensions}}" as="fe">
                <option value="{{fe.extension}}">{{fe.display_name}}</option>
            </template>
        </select>
    </template>

    <script>


        FileBrowser = Polymer({
            is: 'file-browser',
            properties: {
                currentFiles: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                _file_extensions: {
                    type: Array,
                    value: function () {

                        return Polymer.dom(this).querySelectorAll('file-extension');
                    }
                },
                _google_authenticated: {
                    type: Boolean,
                    value: false
                },
                _selected: {type: Number, value: 0},
                _selected_extension: {type: String},
                google_client_id: {
                    type: String,
                    notify: true
                }
            },

            // TODO: Add single file support
            // TODO: Add API to return files or URLs.
            // TODO: Add OneDrive functionality
            // TODO: Add Box.net functionality

            ready: function () {
                var drive = Polymer.dom(this.root).querySelector('#gdrive_api');
                this._selected_extension = "." + this.$.fileExtension.value;

            },

            _set_authenticated_state: function (event) {
                this._google_authenticated = ( event.type === "google-signin-aware-success");
            },

            _google_file_lookup_eventhandler: function (event) {
                this._load_google_files(event.target);
            },

            _file_extension_change: function (event) {
                var loopSize = this.currentFiles.length;
                for(i=0;i < loopSize ;i++){
                    var elem = this.shift('currentFiles');
                    if(elem.selected){
                        this.push('currentFiles', elem);
                    }
                }
                //this.splice('currentFiles', this.currentFiles.size);
                this._selected_extension = "." + this.$.fileExtension.value;
                switch(this._selected){
                    case 1:
                            // Use Google API
                        this._load_google_files(this.$$("#gdrive_api"));
                        break;
                }

            },
            _load_google_files: function (drive) {
                console.log("File Lookup started");

                var addFile = this;
                var fileSearch = drive.api.files.list({
                    q: "fileExtension = '" + this.$.fileExtension.value + "'"
                });

                fileSearch.execute(function (resp) {

                    resp.items.forEach(function (item) {
                        addFile.push('currentFiles', {icon: item.iconLink, fileName: item.originalFilename, selected:false});
                    });
                });
            },

            _google_api_load_error: function (event) {
                console.log("Error");
                if (event.detail.error.code == 401) {
                    checkAuth();
                } else {
                    console.log("Error: Google API failed to load (" + event.detail.error.code + ")");
                }
            },
            _select_file: function(event){
                var file = this.$.fileList.itemForElement(event.target);
                file.selected = event.currentTarget.active;
                var icon = event.currentTarget.queryEffectiveChildren("iron-icon");
                if(file.selected){
                    icon.setAttribute("icon", "remove-circle-outline");
                }else{
                    icon.setAttribute("icon", "add-circle-outline");
                }
            }
        });

    </script>

</dom-module>
